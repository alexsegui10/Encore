<div class="admin-users-page">
  <div class="page-header">
    <h1>Gesti√≥n de Usuarios</h1>
    <button class="btn-primary" (click)="openCreateForm()">
      <span class="icon">+</span> Nuevo Usuario
    </button>
  </div>

  <!-- Barra de b√∫squeda -->
  <div class="search-bar">
    <input
      type="text"
      placeholder="Buscar por nombre, email o biograf√≠a..."
      (input)="onSearch($event)"
      class="search-input"
    />
  </div>

  <!-- Loading state -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando usuarios...</p>
    </div>
  }

  <!-- Tabla de usuarios -->
  @else if (filteredUsers().length > 0) {
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Biograf√≠a</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.uid) {
            <tr>
              <td>
                <div class="user-cell">
                  @if (user.image) {
                    <img [src]="user.image" [alt]="user.username" class="user-avatar" />
                  } @else {
                    <div class="user-avatar-placeholder">{{ user.username.charAt(0).toUpperCase() }}</div>
                  }
                  <div class="user-info">
                    <span class="user-name">{{ user.username }}</span>
                    <span class="user-slug">@{{ user.slug }}</span>
                  </div>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge" [class]="getStatusBadgeClass(user.status)">
                  {{ getStatusText(user.status) }}
                </span>
              </td>
              <td>
                <span class="bio-text">{{ user.bio || 'Sin biograf√≠a' }}</span>
              </td>
              <td>
                <div class="actions-cell">
                  <button class="btn-icon btn-edit" (click)="openEditForm(user)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-icon btn-delete" (click)="deleteUser(user)" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  } @else {
    <div class="empty-state">
      <p>No se encontraron usuarios</p>
    </div>
  }

  <!-- Modal de formulario -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditing() ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
          <button class="btn-close" (click)="closeForm()">√ó</button>
        </div>

        <form [formGroup]="userForm" (ngSubmit)="submitForm()" class="user-form">
          <div class="form-row">
            <div class="form-group">
              <label for="username">Nombre de usuario *</label>
              <input
                type="text"
                id="username"
                formControlName="username"
                class="form-control"
                [class.is-invalid]="userForm.get('username')?.invalid && userForm.get('username')?.touched"
                placeholder="johndoe"
              />
              @if (userForm.get('username')?.invalid && userForm.get('username')?.touched) {
                <div class="invalid-feedback">
                  @if (userForm.get('username')?.errors?.['required']) {
                    <span>El nombre de usuario es requerido</span>
                  }
                  @if (userForm.get('username')?.errors?.['minlength']) {
                    <span>M√≠nimo 3 caracteres</span>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="email">Email *</label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-control"
                [class.is-invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
                placeholder="john@example.com"
              />
              @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
                <div class="invalid-feedback">
                  @if (userForm.get('email')?.errors?.['required']) {
                    <span>El email es requerido</span>
                  }
                  @if (userForm.get('email')?.errors?.['email']) {
                    <span>Debe ser un email v√°lido</span>
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="password">
                Contrase√±a {{ isEditing() ? '(dejar en blanco para mantener)' : '*' }}
              </label>
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-control"
                [class.is-invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
                [placeholder]="isEditing() ? 'Dejar vac√≠o si no deseas cambiarla' : 'M√≠nimo 6 caracteres'"
              />
              @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
                <div class="invalid-feedback">
                  @if (userForm.get('password')?.errors?.['required']) {
                    <span>La contrase√±a es requerida</span>
                  }
                  @if (userForm.get('password')?.errors?.['minlength']) {
                    <span>M√≠nimo 6 caracteres</span>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="status">Estado *</label>
              <select
                id="status"
                formControlName="status"
                class="form-control"
              >
                <option value="active">Activo</option>
                <option value="blocked">Bloqueado</option>
                <option value="pending">Pendiente</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="bio">Biograf√≠a</label>
            <textarea
              id="bio"
              formControlName="bio"
              class="form-control"
              rows="3"
              placeholder="Una breve descripci√≥n del usuario..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="image">URL de imagen</label>
            <input
              type="url"
              id="image"
              formControlName="image"
              class="form-control"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="closeForm()">
              Cancelar
            </button>
            <button type="submit" class="btn-primary" [disabled]="isSubmitting || userForm.invalid">
              {{ isSubmitting ? 'Guardando...' : (isEditing() ? 'Actualizar' : 'Crear') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
